{% extends "reports/base_dashboard.html" %}
{% load static %}

{% block title %}{{ TEMPLATE_DASHBOARD_TITLE }}{% endblock %}

{% block dashboard_content %}
<style>
/* Custom multi-select styles using UAESP palette */
.multiselect-container {
    position: relative;
    display: inline-block;
    width: 100%;
}

.multiselect-dropdown {
    width: 100%;
    padding: 0.625rem 1rem;
    border: 1px solid #e0e0e0;
    border-radius: 0.65rem;
    background-color: white;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 45px;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.25rem;
}

.multiselect-dropdown:hover {
    border-color: var(--uaesp-secondary);
}

.multiselect-dropdown.active {
    border-color: var(--uaesp-secondary);
    box-shadow: 0 0 0 0.25rem rgba(48, 102, 74, 0.15);
}

.multiselect-placeholder {
    color: #6c757d;
    font-size: 0.875rem;
}

.multiselect-options {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid var(--uaesp-secondary);
    border-top: none;
    border-radius: 0 0 0.65rem 0.65rem;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.multiselect-option {
    padding: 0.5rem 1rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
    font-size: 0.875rem;
}

.multiselect-option:hover {
    background-color: rgba(48, 102, 74, 0.1);
}

.multiselect-option.selected {
    background-color: var(--uaesp-accent);
    color: var(--uaesp-primary);
}

.multiselect-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    background-color: var(--uaesp-accent-2);
    color: var(--uaesp-primary);
    padding: 0.25rem 0.5rem;
    border-radius: 0.5rem;
    font-size: 0.75rem;
    font-weight: 500;
}

.multiselect-remove {
    cursor: pointer;
    font-weight: bold;
    color: var(--uaesp-primary);
}

.multiselect-remove:hover {
    color: var(--uaesp-secondary);
}

/* Date range styling */
.date-range-container {
    display: flex;
    gap: 0.5rem;
    align-items: end;
}

.date-range-item {
    flex: 1;
}

/* Custom form styling */
.form-label {
    font-weight: 600;
    color: var(--text-900);
    margin-bottom: 0.5rem;
}

.form-select, .form-control {
    border-radius: 0.65rem;
    border: 1px solid #e0e0e0;
    transition: all 0.2s ease;
}

.form-select:focus, .form-control:focus {
    border-color: var(--uaesp-secondary);
    box-shadow: 0 0 0 0.25rem rgba(48, 102, 74, 0.15);
}

/* Summary cards with UAESP colors */
.summary-card {
    border-radius: 1rem;
    background: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    padding: 1.5rem;
    text-align: center;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.summary-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
}

.summary-card.primary {
    border-left: 4px solid var(--uaesp-primary);
}

.summary-card.success {
    border-left: 4px solid var(--success);
}

.summary-value {
    font-size: 2rem;
    font-weight: 700;
    margin: 0.5rem 0;
}

.summary-value.primary { color: var(--uaesp-primary); }
.summary-value.success { color: var(--success); }
</style>

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-1">{{ TEMPLATE_DASHBOARD_TITLE }}</h1>
            <p class="text-muted mb-0">{{ TEMPLATE_DASHBOARD_DESCRIPTION }}</p>
            <div class="mt-3">
                <a href="{% url 'reports:disposicion_final_dashboard' %}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left"></i> {{ TEMPLATE_BACK_TO_DASHBOARD }}
                </a>
            </div>
        </div>
    </div>

    <!-- Filters Panel -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header" style="background: var(--uaesp-primary); color: white; border-radius: 1rem 1rem 0 0 !important;">
                    <h5 class="mb-0">
                        <button class="btn btn-link text-decoration-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse" aria-expanded="true" style="color: white;">
                            <i class="bi bi-funnel" style="color: var(--uaesp-accent);"></i> {{ TEMPLATE_FILTER_PANEL_TITLE }}
                        </button>
                    </h5>
                </div>
                <div class="collapse show" id="filtersCollapse">
                    <div class="card-body">
                        <form method="GET" id="reportForm">
                            <!-- Date Range -->
                            <div class="row g-3 mb-4">
                                <div class="col-12">
                                    <label class="form-label">{{ TEMPLATE_FILTER_DATE_RANGE }}</label>
                                </div>
                                <div class="col-md-3">
                                    <label for="start_year" class="form-label">{{ TEMPLATE_FILTER_START_YEAR }}</label>
                                    <select class="form-select" name="start_year" id="start_year">
                                        {% for year in years %}
                                        <option value="{{ year }}" {% if current_start_year == year|stringformat:"s" %}selected{% endif %}>{{ year }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="start_month" class="form-label">{{ TEMPLATE_FILTER_START_MONTH }}</label>
                                    <select class="form-select" name="start_month" id="start_month">
                                        {% for month in months %}
                                        <option value="{{ month.value }}" {% if current_start_month == month.value %}selected{% endif %}>{{ month.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="end_year" class="form-label">{{ TEMPLATE_FILTER_END_YEAR }}</label>
                                    <select class="form-select" name="end_year" id="end_year">
                                        {% for year in years %}
                                        <option value="{{ year }}" {% if current_end_year == year|stringformat:"s" %}selected{% endif %}>{{ year }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="end_month" class="form-label">{{ TEMPLATE_FILTER_END_MONTH }}</label>
                                    <select class="form-select" name="end_month" id="end_month">
                                        {% for month in months %}
                                        <option value="{{ month.value }}" {% if current_end_month == month.value %}selected{% endif %}>{{ month.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Multi-select Filters -->
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">{{ TEMPLATE_FILTER_CONCESIONES }}</label>
                                    <div class="multiselect-container">
                                        <div class="multiselect-dropdown" onclick="toggleDropdown('concesiones')">
                                            <span class="multiselect-placeholder" id="concesiones-placeholder">{{ TEMPLATE_FILTER_CONCESIONES_PLACEHOLDER }}</span>
                                            <div id="concesiones-tags"></div>
                                        </div>
                                        <div class="multiselect-options" id="concesiones-options">
                                            {% for concesion in concesiones_options %}
                                            <div class="multiselect-option" data-value="{{ concesion }}" onclick="toggleOption('concesiones', '{{ concesion }}')">
                                                {{ concesion }}
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label">{{ TEMPLATE_FILTER_SERVICIOS }}</label>
                                    <div class="multiselect-container">
                                        <div class="multiselect-dropdown" onclick="toggleDropdown('servicios')">
                                            <span class="multiselect-placeholder" id="servicios-placeholder">{{ TEMPLATE_FILTER_SERVICIOS_PLACEHOLDER }}</span>
                                            <div id="servicios-tags"></div>
                                        </div>
                                        <div class="multiselect-options" id="servicios-options">
                                            {% for servicio in servicios_options %}
                                            <div class="multiselect-option" data-value="{{ servicio }}" onclick="toggleOption('servicios', '{{ servicio }}')">
                                                {{ servicio }}
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label">{{ TEMPLATE_FILTER_ZONAS }}</label>
                                    <div class="multiselect-container">
                                        <div class="multiselect-dropdown" onclick="toggleDropdown('zonas')">
                                            <span class="multiselect-placeholder" id="zonas-placeholder">{{ TEMPLATE_FILTER_ZONAS_PLACEHOLDER }}</span>
                                            <div id="zonas-tags"></div>
                                        </div>
                                        <div class="multiselect-options" id="zonas-options">
                                            {% for zona in zonas_options %}
                                            <div class="multiselect-option" data-value="{{ zona }}" onclick="toggleOption('zonas', '{{ zona }}')">
                                                {{ zona }}
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label">{{ TEMPLATE_FILTER_CATEGORIAS }}</label>
                                    <div class="multiselect-container">
                                        <div class="multiselect-dropdown" onclick="toggleDropdown('categorias')">
                                            <span class="multiselect-placeholder" id="categorias-placeholder">{{ TEMPLATE_FILTER_CATEGORIAS_PLACEHOLDER }}</span>
                                            <div id="categorias-tags"></div>
                                        </div>
                                        <div class="multiselect-options" id="categorias-options">
                                            {% for categoria in categorias_options %}
                                            <div class="multiselect-option" data-value="{{ categoria }}" onclick="toggleOption('categorias', '{{ categoria }}')">
                                                {{ categoria }}
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label">{{ TEMPLATE_FILTER_ORIGENES }}</label>
                                    <div class="multiselect-container">
                                        <div class="multiselect-dropdown" onclick="toggleDropdown('origenes')">
                                            <span class="multiselect-placeholder" id="origenes-placeholder">{{ TEMPLATE_FILTER_ORIGENES_PLACEHOLDER }}</span>
                                            <div id="origenes-tags"></div>
                                        </div>
                                        <div class="multiselect-options" id="origenes-options">
                                            {% for origen in origenes_options %}
                                            <div class="multiselect-option" data-value="{{ origen }}" onclick="toggleOption('origenes', '{{ origen }}')">
                                                {{ origen }}
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label">{{ TEMPLATE_FILTER_PIDJ }}</label>
                                    <div class="multiselect-container">
                                        <div class="multiselect-dropdown" onclick="toggleDropdown('pidj')">
                                            <span class="multiselect-placeholder" id="pidj-placeholder">{{ TEMPLATE_FILTER_PIDJ_PLACEHOLDER }}</span>
                                            <div id="pidj-tags"></div>
                                        </div>
                                        <div class="multiselect-options" id="pidj-options">
                                            <div class="multiselect-option" data-value="PIDJ" onclick="toggleOption('pidj', 'PIDJ')">
                                                {{ TEMPLATE_FILTER_PIDJ_OPTION_PIDJ }}
                                            </div>
                                            <div class="multiselect-option" data-value="No Aplica" onclick="toggleOption('pidj', 'No Aplica')">
                                                {{ TEMPLATE_FILTER_PIDJ_OPTION_NOT_APPLICABLE }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Hidden inputs for form submission -->
                            <input type="hidden" name="concesiones" id="concesiones-input">
                            <input type="hidden" name="servicios" id="servicios-input">
                            <input type="hidden" name="zonas" id="zonas-input">
                            <input type="hidden" name="categorias" id="categorias-input">
                            <input type="hidden" name="origenes" id="origenes-input">
                            <input type="hidden" name="dispuestos_pidj" id="pidj-input">
                            
                            <!-- Action Buttons -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <button type="button" class="btn btn-primary" onclick="submitForm()">
                                        <i class="bi bi-search"></i> {{ TEMPLATE_FILTER_BUTTON_RUN }}
                                    </button>
                                    <a href="{% url 'reports:df_export_report_csv' %}" class="btn btn-success" id="exportBtn">
                                        <i class="bi bi-file-earmark-excel"></i> {{ TEMPLATE_FILTER_BUTTON_EXPORT }}
                                    </a>
                                    <button type="button" class="btn btn-secondary" onclick="resetFilters()">
                                        <i class="bi bi-arrow-clockwise"></i> {{ TEMPLATE_FILTER_BUTTON_RESET }}
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    {% if total_records > 0 %}
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="summary-card primary">
                <h5 class="card-title">{{ TEMPLATE_SUMMARY_TOTAL_RECORDS }}</h5>
                <div class="summary-value primary">{{ total_records|floatformat:0 }}</div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="summary-card success">
                <h5 class="card-title">{{ TEMPLATE_SUMMARY_TOTAL_WEIGHT }}</h5>
                <div class="summary-value success">{{ total_weight|floatformat:2 }}</div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Results Table -->
    {% if page_obj %}
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">{{ TEMPLATE_TABLE_RESULTS_TITLE }}</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    {% for column in columns %}
                                    <th>{{ column }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in page_obj %}
                                <tr>
                                    {% for value in row %}
                                    <td>
                                        {% if value is None %}
                                            -
                                        {% elif forloop.counter == 6 %} <!-- PESO RESIDUOS TON -->
                                            {{ value|floatformat:2 }}
                                        {% else %}
                                            {{ value }}
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    {% if page_obj.has_other_pages %}
                    <nav aria-label="{{ TEMPLATE_PAGINATION_LABEL }}">
                        <ul class="pagination pagination-sm mb-0 justify-content-center">
                            <!-- Primera página -->
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1" title="{{ TEMPLATE_PAGINATION_FIRST_TITLE }}">
                                        <i class="bi bi-chevron-double-left"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}" title="{{ TEMPLATE_PAGINATION_PREV_TITLE }}">
                                        <i class="bi bi-chevron-left"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">
                                        <i class="bi bi-chevron-double-left"></i>
                                    </span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link">
                                        <i class="bi bi-chevron-left"></i>
                                    </span>
                                </li>
                            {% endif %}

                            <!-- Páginas numeradas -->
                            {% for num in page_obj.paginator.page_range %}
                                {% if page_obj.number == num %}
                                    <li class="page-item active">
                                        <span class="page-link bg-primary border-primary text-white">{{ num }}</span>
                                    </li>
                                {% elif num > page_obj.number|add:'-2' and num < page_obj.number|add:'2' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                                    </li>
                                {% elif num == 1 or num == page_obj.paginator.num_pages %}
                                    <li class="page-item">
                                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                                    </li>
                                {% elif num == page_obj.number|add:'-3' or num == page_obj.number|add:'3' %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            <!-- Última página -->
                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}" title="{{ TEMPLATE_PAGINATION_NEXT_TITLE }}">
                                        <i class="bi bi-chevron-right"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.paginator.num_pages }}" title="{{ TEMPLATE_PAGINATION_LAST_TITLE }}">
                                        <i class="bi bi-chevron-double-right"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">
                                        <i class="bi bi-chevron-right"></i>
                                    </span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link">
                                        <i class="bi bi-chevron-double-right"></i>
                                    </span>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> {{ TEMPLATE_NO_RESULTS_MESSAGE }}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal de generación de reporte -->
<div class="modal fade" id="reportGenerationModal" tabindex="-1" aria-labelledby="reportGenerationModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false" data-modal-dynamic="{{ TEMPLATE_MODAL_EXPORT_DYNAMIC }}" data-modal-dynamic-filters="{{ TEMPLATE_MODAL_EXPORT_DYNAMIC_FILTERS }}" data-modal-dynamic-suffix="{{ TEMPLATE_MODAL_EXPORT_DYNAMIC_SUFFIX }}" data-modal-filters-zero="{{ TEMPLATE_MODAL_EXPORT_FILTERS_ZERO }}">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reportGenerationModalLabel">
                    <i class="bi bi-file-earmark-excel text-success me-2"></i>{{ TEMPLATE_MODAL_EXPORT_TITLE }}
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">{{ TEMPLATE_MODAL_EXPORT_SPINNER }}</span>
                    </div>
                </div>
                <p class="mb-0" id="generationMessage">{{ TEMPLATE_MODAL_EXPORT_MESSAGE }}</p>
                <small class="text-muted">{{ TEMPLATE_MODAL_EXPORT_WARNING }}</small>
            </div>
        </div>
    </div>
</div>

<script>
// Multi-select functionality
let selectedOptions = {
    concesiones: JSON.parse('{{ current_concesiones|escapejs }}'),
    servicios: JSON.parse('{{ current_servicios|escapejs }}'),
    zonas: JSON.parse('{{ current_zonas|escapejs }}'),
    categorias: JSON.parse('{{ current_categorias|escapejs }}'),
    origenes: JSON.parse('{{ current_origenes|escapejs }}'),
    pidj: JSON.parse('{{ current_pidj|escapejs }}')
};

function toggleDropdown(type) {
    const dropdown = document.getElementById(type + '-options');
    const container = dropdown.parentElement.querySelector('.multiselect-dropdown');
    
    if (!dropdown || !container) {
        console.error('Dropdown elements not found for type:', type);
        return;
    }
    
    // Close all other dropdowns
    document.querySelectorAll('.multiselect-options').forEach(opt => {
        if (opt !== dropdown) {
            opt.style.display = 'none';
            const otherContainer = opt.parentElement.querySelector('.multiselect-dropdown');
            if (otherContainer) {
                otherContainer.classList.remove('active');
            }
        }
    });
    
    // Toggle current dropdown
    if (dropdown.style.display === 'block') {
        dropdown.style.display = 'none';
        container.classList.remove('active');
    } else {
        dropdown.style.display = 'block';
        container.classList.add('active');
    }
}

function toggleOption(type, value) {
    if (!selectedOptions[type]) {
        selectedOptions[type] = [];
    }
    
    const index = selectedOptions[type].indexOf(value);
    if (index > -1) {
        selectedOptions[type].splice(index, 1);
    } else {
        selectedOptions[type].push(value);
    }
    
    updateDisplay(type);
    updateHiddenInputs();
}

function updateDisplay(type) {
    const tagsContainer = document.getElementById(type + '-tags');
    const placeholder = document.getElementById(type + '-placeholder');
    
    if (!tagsContainer || !placeholder) {
        return;
    }
    
    tagsContainer.innerHTML = '';
    
    if (selectedOptions[type].length > 0) {
        placeholder.style.display = 'none';
        selectedOptions[type].forEach(value => {
            const tag = document.createElement('span');
            tag.className = 'multiselect-tag';
            tag.innerHTML = `${value} <span class="multiselect-remove" onclick="removeOption('${type}', '${value}')">&times;</span>`;
            tagsContainer.appendChild(tag);
        });
    } else {
        placeholder.style.display = 'block';
    }
    
    // Update option selection state
    const options = document.querySelectorAll(`#${type}-options .multiselect-option`);
    options.forEach(option => {
        if (selectedOptions[type].includes(option.dataset.value)) {
            option.classList.add('selected');
        } else {
            option.classList.remove('selected');
        }
    });
}

function removeOption(type, value) {
    const index = selectedOptions[type].indexOf(value);
    if (index > -1) {
        selectedOptions[type].splice(index, 1);
        updateDisplay(type);
        updateHiddenInputs();
    }
}

function updateHiddenInputs() {
    Object.keys(selectedOptions).forEach(type => {
        // Remove all existing hidden inputs for this type
        const existingInputs = document.querySelectorAll(`input[name="${type}"]`);
        existingInputs.forEach(input => input.remove());
        
        // Create new hidden inputs for each selected value
        selectedOptions[type].forEach(value => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = type;
            input.value = value;
            document.getElementById('reportForm').appendChild(input);
        });
    });
}

// Initialize displays
Object.keys(selectedOptions).forEach(type => {
    updateDisplay(type);
});
updateHiddenInputs();

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.multiselect-container')) {
        document.querySelectorAll('.multiselect-options').forEach(opt => {
            opt.style.display = 'none';
            opt.parentElement.querySelector('.multiselect-dropdown').classList.remove('active');
        });
    }
});

// Form submission function
function submitForm() {
    const form = document.getElementById('reportForm');
    const formData = new FormData(form);
    
    // Build URL with parameters - URLSearchParams handles multiple values with same name correctly
    const params = new URLSearchParams();
    
    // Add all form data, including multiple values for same key
    for (let [key, value] of formData.entries()) {
        params.append(key, value);
    }
    
    const currentUrl = window.location.pathname;
    window.location.href = currentUrl + '?' + params.toString();
}

// Export button functionality
document.getElementById('exportBtn').addEventListener('click', function(e) {
    e.preventDefault();
    showReportGenerationModal(this);
});

// Función para mostrar el modal de generación de reporte
function showReportGenerationModal(exportBtn) {
    // Actualizar mensaje con información del reporte
    const form = document.getElementById('reportForm');
    const formData = new FormData(form);
    const modalElement = document.getElementById('reportGenerationModal');
    const dynamicTemplate = modalElement.dataset.modalDynamic || '';
    const dynamicFiltersTemplate = modalElement.dataset.modalDynamicFilters || '';
    const dynamicSuffix = modalElement.dataset.modalDynamicSuffix || '';
    const dynamicZeroFilters = modalElement.dataset.modalFiltersZero || '';

    // Contar filtros seleccionados para personalizar el mensaje
    let selectedFilters = 0;
    Object.keys(selectedOptions).forEach(type => {
        if (selectedOptions[type].length > 0) {
            selectedFilters += selectedOptions[type].length;
        }
    });

    const startYear = document.getElementById('start_year').value;
    const endYear = document.getElementById('end_year').value;
    const startMonth = document.getElementById('start_month').value;
    const endMonth = document.getElementById('end_month').value;

    let message = dynamicTemplate
        .replace('{start_year}', startYear)
        .replace('{start_month}', startMonth)
        .replace('{end_year}', endYear)
        .replace('{end_month}', endMonth);
    if (selectedFilters > 0 && dynamicFiltersTemplate) {
        message += dynamicFiltersTemplate.replace('{filters}', selectedFilters);
    } else if (!selectedFilters && dynamicZeroFilters) {
        message += dynamicZeroFilters;
    }
    message += dynamicSuffix;
    
    document.getElementById('generationMessage').textContent = message;
    
    // Mostrar modal
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
    
    // Construir URL de exportación y iniciar descarga después de mostrar el modal
    setTimeout(() => {
        const params = new URLSearchParams();
        
        // Add all form data, including multiple values for same key
        for (let [key, value] of formData.entries()) {
            params.append(key, value);
        }
        
        // Construir URL de exportación
        const exportUrl = exportBtn.getAttribute('href') + '?' + params.toString();
        
        // Ocultar el modal antes de iniciar la descarga
        const modal = bootstrap.Modal.getInstance(document.getElementById('reportGenerationModal'));
        if (modal) {
            modal.hide();
        }
        
        // Pequeño delay para que el modal se oculte antes de la descarga
        setTimeout(() => {
            window.location.href = exportUrl;
        }, 300);
    }, 800);
}

// Reset filters function
function resetFilters() {
    document.getElementById('reportForm').reset();
    
    // Reset multi-selects
    Object.keys(selectedOptions).forEach(type => {
        selectedOptions[type] = [];
        updateDisplay(type);
    });
    updateHiddenInputs();
    
    // Set default date range
    const currentYear = new Date().getFullYear();
    document.getElementById('start_year').value = currentYear;
    document.getElementById('end_year').value = currentYear;
    document.getElementById('start_month').value = '1';
    document.getElementById('end_month').value = '12';
}
</script>

{% endblock %}